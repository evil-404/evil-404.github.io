<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=">


  <link rel="mask-icon" href="/images/logo.svg?v=" color="#222">





  <meta name="keywords" content="openvpn," />





  <link rel="alternate" href="/atom.xml" title="Evil-404" type="application/atom+xml" />






<meta name="description" content="0x01 关于openvpn12一种基于OpenSSL加密库的开源VPN实现,此处的主要目的还是旨在说明如何快速安全部署openvpn关于其内部的加解密细节及封装与解封装过程,相信大家都已经比较熟练了,此处不做过多涉及,暂以实战上手应用为主 0x02 openvpn 可工作于两种不同的模式,使用 TUN / TAP 作为接口建立隧道,但需要相应内核支持123TUN 接口创建的是三层路由隧道,实际中">
<meta name="keywords" content="openvpn">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenVpn 安全部署实战指南 [一]">
<meta property="og:url" content="https://evil-404.github.io/hidsdesd-vpn.html">
<meta property="og:site_name" content="Evil-404">
<meta property="og:description" content="0x01 关于openvpn12一种基于OpenSSL加密库的开源VPN实现,此处的主要目的还是旨在说明如何快速安全部署openvpn关于其内部的加解密细节及封装与解封装过程,相信大家都已经比较熟练了,此处不做过多涉及,暂以实战上手应用为主 0x02 openvpn 可工作于两种不同的模式,使用 TUN / TAP 作为接口建立隧道,但需要相应内核支持123TUN 接口创建的是三层路由隧道,实际中">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://evil-404.github.io/img/ca%20key.png">
<meta property="og:image" content="https://evil-404.github.io/img/server%20key.png">
<meta property="og:image" content="https://evil-404.github.io/img/client%20key.png">
<meta property="og:image" content="https://evil-404.github.io/img/client%20key%20res.png">
<meta property="og:image" content="https://evil-404.github.io/img/client%20key%20pass.png">
<meta property="og:image" content="https://evil-404.github.io/img/client%20key%20pass%20res.png">
<meta property="og:image" content="https://evil-404.github.io/img/dh1024%20key.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20start.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20start%20res.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20start%20initd.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20start%20log.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20client%20install.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20client%20install%20res.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20client%20download.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20client%20connect%20res.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20client%20connect.png">
<meta property="og:image" content="https://evil-404.github.io/img/linux%20conenect%20in.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20in%20net%20.png">
<meta property="og:image" content="https://evil-404.github.io/img/openvpn%20in%20net%20res%20.png">
<meta property="og:image" content="https://evil-404.github.io/img/secode%20network.png">
<meta property="og:image" content="https://evil-404.github.io/img/secode%20network%20res.png">
<meta property="og:image" content="https://evil-404.github.io/img/iptables%20three.png">
<meta property="og:image" content="https://evil-404.github.io/img/iptables%20three%20res.png">
<meta property="og:image" content="https://evil-404.github.io/img/client%20error.png">
<meta property="og:updated_time" content="2017-12-22T13:41:38.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenVpn 安全部署实战指南 [一]">
<meta name="twitter:description" content="0x01 关于openvpn12一种基于OpenSSL加密库的开源VPN实现,此处的主要目的还是旨在说明如何快速安全部署openvpn关于其内部的加解密细节及封装与解封装过程,相信大家都已经比较熟练了,此处不做过多涉及,暂以实战上手应用为主 0x02 openvpn 可工作于两种不同的模式,使用 TUN / TAP 作为接口建立隧道,但需要相应内核支持123TUN 接口创建的是三层路由隧道,实际中">
<meta name="twitter:image" content="https://evil-404.github.io/img/ca%20key.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'LPBE9XRFRL',
      apiKey: '246a90c6ff16be5d5708e201cf6d7158',
      indexName: 'API',
      hits: {"per_page":10},
      labels: {"input_placeholder":"输入关键字搜索","hits_empty":"“没有找到与 ${query} 相关的内容”","hits_stats":"“搜索到 ${hits} 条相关记录，共耗时 ${time} ms”"}
    }
  };
</script>



  <link rel="canonical" href="https://evil-404.github.io/hidsdesd-vpn.html"/>





  <title>OpenVpn 安全部署实战指南 [一] | Evil-404</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Evil-404</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">专注于 APT 攻防研究,致力于高质量实用干货分享</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-nav">
          <a href="/nav/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            导航
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://evil-404.github.io/hidsdesd-vpn.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="VK">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws1.sinaimg.cn/large/baeae4e0ly1fsu7yzju7lj20af0a0wej.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Evil-404">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">OpenVpn 安全部署实战指南 [一]</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-12-10T00:13:48+08:00">
                2014-12-10
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2017-12-22T21:41:38+08:00">
                2017-12-22
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            

            

              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vpn-config/" itemprop="url" rel="index">
                    <span itemprop="name">vpn config</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,016
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  17
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><br><br>0x01 关于openvpn<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">一种基于OpenSSL加密库的开源VPN实现,此处的主要目的还是旨在说明如何快速安全部署openvpn</span><br><span class="line">关于其内部的加解密细节及封装与解封装过程,相信大家都已经比较熟练了,此处不做过多涉及,暂以实战上手应用为主</span><br></pre></td></tr></table></figure></p>
<p>0x02 openvpn 可工作于两种不同的模式,使用 TUN / TAP 作为接口建立隧道,但需要相应内核支持<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TUN 接口创建的是三层路由隧道,实际中用的较多,TAP 是二层网卡桥接隧道,即创建一个以太网桥接,相对复杂</span><br><span class="line">TAP 接口的好处在于,客户端可以获得 VPN 服务器所处子网的<span class="built_in"> IP </span>[即,忽略物理上的区别,可以完全将客户端看做是与VPN服务器处于同一子网的另一台机器]</span><br><span class="line">而TUN 接口下所有的客户端则处于一个完全独立的子网内,与 VPN 服务器所在的子网没有关系,待到后面实际部署时,会深有体会的</span><br></pre></td></tr></table></figure></p>
<p>0x03 下面则是 openvpn 提供的两种安全模式<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Static Key</span><br><span class="line">X509 PKI [Public Key Infrastructure]</span><br></pre></td></tr></table></figure></p>
<p>此次演示环境<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenVpnServer</span>  	  <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.3</span><span class="selector-class">.71</span> <span class="selector-attr">[假设为公网ip]</span>   <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.6</span><span class="selector-class">.39</span> <span class="selector-attr">[假设为其所在的内网ip]</span> <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.7</span><span class="selector-class">.39</span> <span class="selector-attr">[假设为其所在的另一个内网ip]</span></span><br><span class="line"><span class="selector-tag">OpenVpnClient</span>	  <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.6</span><span class="selector-class">.41</span> <span class="selector-attr">[内网ip]</span> 	   <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.7</span><span class="selector-class">.41</span> <span class="selector-attr">[另一个内网ip段]</span>	为<span class="selector-tag">OpenVpnServer</span>所在内网段的一台<span class="selector-tag">linux</span>机器</span><br><span class="line"><span class="selector-tag">win7cn</span>		  <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.32</span><span class="selector-class">.253</span> <span class="selector-attr">[本地机器的内网ip]</span> 作为连接<span class="selector-tag">OpenVpnServer</span>的<span class="selector-tag">windows</span>访问客户端</span><br><span class="line"><span class="selector-tag">CentOS6</span><span class="selector-class">.8_x86_64</span>  <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.32</span><span class="selector-class">.136</span> <span class="selector-attr">[本地机器的内网ip]</span> 作为连接<span class="selector-tag">OpenVpnServer</span>的<span class="selector-tag">linux</span>访问客户端</span><br></pre></td></tr></table></figure></p>
<p>我们要实现的最终目的<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">通过拨入 <span class="selector-tag">OpenVpnServer</span> 可在本地直接访问远程内网,即`192<span class="selector-class">.168</span><span class="selector-class">.32</span><span class="selector-class">.x</span>`和`192<span class="selector-class">.168</span><span class="selector-class">.6</span><span class="selector-class">.x</span>`,本身是两个完全独立相互不同的内网段</span><br><span class="line">但现在要实现的效果就是,可以直接在<span class="selector-tag">win7cn</span>或者<span class="selector-tag">CentOS6</span><span class="selector-class">.8</span>上<span class="selector-tag">ping</span>通<span class="selector-tag">OpenVpnServer</span>所在内网中的<span class="selector-tag">OpenVpnClient</span>机器</span><br></pre></td></tr></table></figure></p>
<p>0x04 Ok,明确了最终目的之后,我们就开始来实战部署OpenVpn</p>
<p>首先,进行一些前期的必要环境准备,务必严格保证所有机器时间完全一致,此项非常重要,否则后期OpenVpn客户端在连服务端时会出现证书无法被验证的情况<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/sbin/ntpdate time.nist.gov  先手工在所有机器上同步一次,之后再加到计划任务中自动同步即可</span></span><br><span class="line"><span class="comment"># crontab -e</span></span><br><span class="line">  *<span class="regexp">/2 * * * * /usr</span><span class="regexp">/sbin/ntpdate</span> time.nist.gov &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"><span class="comment"># crontab -l</span></span><br></pre></td></tr></table></figure></p>
<p>安装C编译器及openssl加密库,众所周知,openvpn依赖openssl对隧道数据进行加密<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum install -y  gcc gcc-c++ openssl openssl-devel</span></span><br></pre></td></tr></table></figure></p>
<p>禁用selinux,之后一定要记得重启下系统,才可生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> setenforce 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">'/^SELINUX=/c\SELINUX=disabled'</span> /etc/selinux/config</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> shutdown -r now</span></span><br></pre></td></tr></table></figure></p>
<p>准备好环境所需的源码包,此,分别为数据压缩库和openvpn自身的源码包<code>openvpn的下载地址可能已经被墙掉了,大家暂时挂ss下一下就好了</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget http://www.oberhumer.com/opensource/lzo/download/lzo-2.06.tar.gz</span></span><br><span class="line"><span class="comment"># wget https://build.openvpn.net/downloads/releases/openvpn-2.2.2.tar.gz</span></span><br></pre></td></tr></table></figure></p>
<p>编译安装LZO,主要用它来压缩通信数据加快传输速度<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> tar xf lzo-2.06.tar.gz</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> lzo-2.06</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ./configure &amp;&amp; make &amp;&amp; make install</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> $?</span></span><br></pre></td></tr></table></figure></p>
<p>0x05 编译安装OpenVPN,记得要载入lzo一起编译<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -zxf openvpn-2.2.2.tar.gz</span></span><br><span class="line"><span class="comment"># cd openvpn-2.2.2</span></span><br><span class="line"><span class="comment"># ./configure --with-lzo-headers=/usr/local/lzo/include --with-lzo-lib=/usr/local/lzo/lib</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br><span class="line"><span class="comment"># echo $?</span></span><br><span class="line"><span class="comment"># which openvpn  如果能看到路径,说明openvpn已经基本安装成功,默认是在/usr/local/sbin/openvpn目录下</span></span><br></pre></td></tr></table></figure></p>
<p>0x06 安装成功后,我们就开始来实际部署配置OpenVpn</p>
<p>首先,修改默认证书信息,而后,以此来创建各种证书<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /root/openvpn-2.2.2/easy-rsa/2.0/ &amp;&amp; ll</span></span><br><span class="line"><span class="comment"># cp vars vars.bak</span></span><br><span class="line"><span class="comment"># vi vars</span></span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_COUNTRY</span>=<span class="string">"CN"</span></span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_PROVINCE</span>=<span class="string">"BJ"</span></span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_CITY</span>=<span class="string">"BeiJing"</span></span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_ORG</span>=<span class="string">"klionsec"</span></span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_EMAIL</span>=<span class="string">"klion@rootkit.org"</span></span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_EMAIL</span>=klion@rootkit.org</span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_CN</span>=CN</span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_NAME</span>=kliosec</span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_OU</span>=klionsec</span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">PKCS11_MODULE_PATH</span>=changeme</span><br><span class="line">  <span class="builtin-name">export</span> <span class="attribute">PKCS11_PIN</span>=1234</span><br><span class="line"><span class="comment"># tail -n 11 vars</span></span><br><span class="line"><span class="comment"># source vars	重新载入,让变量生效</span></span><br><span class="line"><span class="comment"># ./clean-all  	把之前已有的证书全部先删掉</span></span><br><span class="line"><span class="comment"># ./build-ca   	创建ca证书ca.crt 及根密钥ca.key [基本上一路按回车就好],因为在vars文件中已经定义好了默认的变量值,生成时会自动逐个读取</span></span><br><span class="line"><span class="comment"># ll keys/   	看下刚刚生成的ca证书在keys目录里有没有</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/img/ca key.png" alt=""></p>
<p>创建服务端证书及密钥 <code>[ 中间会有一处让你输入密码,注意,后续创建证书时的密码最好都跟此密码保持一致,防止认证失败,之后再按照提示输入两次y即可]</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ./build-key-server server</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ll keys/</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/img/server key.png" alt=""></p>
<p>创建完服务端证书和秘钥后,我们还需要为每一个登陆到OpenVpn服务器的客户端创建一个证书,注意直接用<code>build-key</code>创建的客户端证书默认是没密码的,也就是说,别人只要拿到你的这套客户端的证书就可以直接连上vpn服务器,有一定风险,当然,前提也得服务端配置中允许同一用户多点登陆才行,后续如果还要新增客户端用户,只需要再用build-key生成即可<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./build-key client  注意,这里也会提示输入密码,为了避免出问题,和上面创建服务端证书时设置的密码保持一致即可</span></span><br><span class="line"><span class="comment"># ll keys/</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/img/client key.png" alt=""><br><img src="/img/client key res.png" alt=""></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ./<span class="keyword">build</span>-<span class="keyword">key</span>-pass clientsec 如果你想创建带密码的客户端证书,直接用 <span class="keyword">build</span>-<span class="keyword">key</span>-pass 来创建即可</span><br><span class="line"># ll <span class="keyword">keys</span>/</span><br></pre></td></tr></table></figure>
<p><img src="/img/client key pass.png" alt=""><br><img src="/img/client key pass res.png" alt=""></p>
<p>创建秘钥交换协议文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ./build-dh    即迪菲·赫尔曼密钥,会生成dh1024.pem文件,生成过程可能会比较慢,在此期间不要去中断它</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ll keys/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> openvpn --genkey --secret keys/ta.key  生成ta.key文件,防DDos攻击,UDP淹没等恶意攻击,说实话,效果貌似并不太好</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/img/dh1024 key.png" alt=""></p>
<p>0x07 创建并修改openvpn服务器配置文件,将需要用到的openvpn证书和密钥复制一份到创建好的keys目录中<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir -pv /etc/openvpn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /root/openvpn-2.2.2/easy-rsa/2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp -ap keys/ /etc/openvpn/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> ../../</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp sample-config-files/&#123;server.conf,client.conf&#125; /etc/openvpn/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tree /etc/openvpn/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span>  /etc/openvpn/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp -a server.conf server.conf.bak</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> grep <span class="string">'^[^#;]'</span> /etc/openvpn/server.conf &gt; tmp.txt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat tmp.txt &gt; server.conf</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 下面是openvpn服务端的完整配置</span></span><br><span class="line"><span class="meta"># vi server.conf</span></span><br><span class="line">  <span class="keyword">local</span> <span class="number">192.168</span><span class="number">.3</span><span class="number">.71</span>			 <span class="meta"># 要绑定到的公网ip</span></span><br><span class="line">  port <span class="number">11941</span>				 <span class="meta"># openvpn服务的默认端口,最好改掉,其实,别人如果全端口扫描还是能扫到 </span></span><br><span class="line">  proto tcp				 <span class="meta"># 使用tcp协议,相对稳定</span></span><br><span class="line">  dev tun				 <span class="meta"># 此处使用tun接口</span></span><br><span class="line">  ca /etc/openvpn/keys/ca.crt		 <span class="meta"># ca证书路径</span></span><br><span class="line">  cert /etc/openvpn/keys/server.crt	 </span><br><span class="line">  <span class="built_in">key</span> /etc/openvpn/keys/server.<span class="built_in">key</span>	 <span class="meta"># openvpn服务端证书路径 </span></span><br><span class="line">  dh /etc/openvpn/keys/dh1024.pem	 </span><br><span class="line">  server <span class="number">10.18</span><span class="number">.0</span><span class="number">.0</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>	 <span class="meta"># openvpn内网ip地址池 </span></span><br><span class="line">  <span class="keyword">push</span> <span class="string">"route 192.168.6.0 255.255.255.0"</span> <span class="meta"># 此项非常重要,即vpn服务器所在的内网段</span></span><br><span class="line">  <span class="keyword">push</span> <span class="string">"route 192.168.7.0 255.255.255.0"</span> <span class="meta"># 如果想让别人拨入成功后能直接跟vpn所在的内网段的机器进行通信,就需要用此方式把配置推到每个客户端</span></span><br><span class="line">  client-to-client			 <span class="meta"># 让openvpn客户端和客户端能相互通信</span></span><br><span class="line">  duplicate-cn				 <span class="meta"># 同一个vpn账号允许同时多点登陆,在上面已经提到过</span></span><br><span class="line">  ifconfig-pool-persist ipp.txt		 </span><br><span class="line">  keepalive <span class="number">10</span> <span class="number">120</span>			 <span class="meta"># 发心跳包,每10一次,如果超过120秒都没动静,就自动断开</span></span><br><span class="line">  comp-lzo				 <span class="meta"># 启用传输数据压缩</span></span><br><span class="line">  persist-<span class="built_in">key</span>		</span><br><span class="line">  persist-tun				 </span><br><span class="line">  status openvpn-status.<span class="built_in">log</span>		 <span class="meta"># 开启OpenVpn服务端日志</span></span><br><span class="line">  <span class="built_in">log</span> /var/<span class="built_in">log</span>/openvpn.<span class="built_in">log</span>		 <span class="meta"># 指定日志存放位置</span></span><br><span class="line">  verb <span class="number">3</span>				 <span class="meta"># 指定记录的日志级别</span></span><br></pre></td></tr></table></figure>
<p>0x08 修改完OpenVpn服务端配置后,我们再来稍微调整一些系统配置,如下</p>
<p>开启系统路由转发,因为在拨入成功后还要访问vpn服务器所在内网中的其它机器,所以转发是必须的<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">'/net.ipv4.ip_forward/s/0/1/'</span> /etc/sysctl.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sysctl -p</span></span><br></pre></td></tr></table></figure></p>
<p>如果开了iptables,记得把tcp的11941端口<code>[实际中是你自己设置的openvpn服务端口]</code>和转发都放开,不然客户端可能会连不上,如果压根没开,可暂时不用管<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/iptables</span></span><br><span class="line">  -A INPUT -p tcp --dport 11941 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> iptables -A INPUT -p tcp --dport 11941 -j ACCEPT</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iptables -L -n</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/init.d/iptables status</span></span><br></pre></td></tr></table></figure></p>
<p>最后,我们来尝试启动OpenVpn服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/sbin/openvpn --config /etc/openvpn/server.conf &amp;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> netstat -tulnp | grep openvpn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"/usr/local/sbin/openvpn --config /etc/openvpn/server.conf &amp;"</span> &gt;&gt; /etc/rc.local</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tail -n 1 /etc/rc.local</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ifconfig  -a  openvpn服务一旦成功启动系统中就会多出一个名为tun0的虚拟网卡</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pkill openvpn</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/img/openvpn start.png" alt=""><br><img src="/img/openvpn start res.png" alt=""></p>
<p>当然,除了手工去加载服务端配置文件来启动,你也可以用openvpn自己提供好的服务启动脚本来配置成常规启动,只是自己不太喜欢这样搞,过程非常简单,如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cp /root/openvpn-2.2.2/sample-scripts/openvpn.init /etc/init.d/openvpn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chmod 700 /etc/init.d/openvpn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chkconfig openvpn on</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chkconfig --list</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/init.d/openvpn restart  会有报错</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/init.d/openvpn       把148行的*.conf改成server.conf,这个目录下不能有多个.conf否则就会被干扰到</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/init.d/openvpn restart  正常启动</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> lsof -i :1194</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/img/openvpn start initd.png" alt=""><br><img src="/img/openvpn start log.png" alt=""></p>
<p>0x09 把服务端完全搞定以后,我们再来看如何在不同系统平台下配置OpenVpn客户端进行连接</p>
<p>先下载并安装好 OpenVpn 的windows版客户端工具,地址已被墙<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>//swupdate.openvpn<span class="meta">.org</span>/community/releases/openvpn<span class="number">-2.2</span><span class="number">.2</span>-install.exe</span><br></pre></td></tr></table></figure></p>
<p>此时,再到OpenVpn服务端去把指定客户端的证书及配置文件都下载下来<code>[此处以client用户为例]</code>,之后再把这些文件全部复制到你OpenVpn客户端的config目录中,此处的OpenVpn客户端config目录是在如下的路径上,而你则要根据你自己的OpenVpn客户端安装目录来调整<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/openvpn/keys/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sz ca.crt client.crt client.key</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ca<span class="selector-class">.crt</span> client<span class="selector-class">.crt</span> client<span class="selector-class">.key</span>  	所有要复制的文件</span><br><span class="line">C:\Program Files\OpenVPN\config	要复制到的目录</span><br></pre></td></tr></table></figure>
<p><img src="/img/openvpn client install.png" alt=""><br><img src="/img/openvpn client install res.png" alt=""><br><img src="/img/openvpn client download.png" alt=""></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手工创建好客户端配置文件,文件具体内容如下,注意在windows中客户端配置文件名必须为 client.ovpn </span></span><br><span class="line"></span><br><span class="line">client			  # 声明是客户端</span><br><span class="line">dev tun			  # 和服务端保持一致,使用tun接口</span><br><span class="line">proto tcp		  # 同样使用tcp协议,保持一致,不然就没法和服务端进行正常通信了</span><br><span class="line">remote 192.168.3.71 11941 # Openvpn 服务端的ip和端口</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt		  # 客户端证书所在路径</span><br><span class="line">cert client.crt</span><br><span class="line">key client.key</span><br><span class="line">ns-cert-type server</span><br><span class="line">comp-lzo		  # 压缩传输</span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure>
<p>之后,再右键以<code>管理员权限</code>运行openvpn客户端,点击<code>connect</code> 进行连接即可,如下即表示连接成功,至此,整个OpenVpn的部署工作也就完成了百分之八十,但我们的最终目的是希望能在本地通过拨入vpn直接跟远程内网中的机器进行通信,再次明确目的之后,我们继续</p>
<p><img src="/img/openvpn client connect res.png" alt=""><br><img src="/img/openvpn client connect.png" alt=""></p>
<p>0x10 以上是使用windows客户端来连接OpenVpn服务端,至于如何在linux中使用客户端连接OpenVpn服务端就更简单了,跟OpenVpn服务端一样,先装好OpenVpn,之后只需用openvpn工具加载对应的客户端配置文件即可,注意,是客户端配置文件,另外,此处不需要再配置服务端,单单只是用下openvpn工具而已,具体如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir /etc/openvpn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/openvpn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rz  可以直接把刚刚client的一套证书丢上去</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tree ./</span></span><br><span class="line"> ├── ca.crt</span><br><span class="line"> ├── client.conf</span><br><span class="line"> ├── client.crt</span><br><span class="line"> └── client.key</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 断开以后,第二次重连可能会有些问题,把客户端配置文件改个名就好了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/sbin/openvpn --config /etc/openvpn/client.conf &amp;</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/img/linux conenect in.png" alt=""></p>
<p>0x11 再回到我们的最终目的上,<code>如何在本地通过vpn直接跟远程内网进行通信</code>,方式大概有三种,如下</p>
<p>第一种,把所有要通信的远程内网中的机器的网关都指向OpenVpn服务器的ip,这样,包在回传的时候就能找到本地机器,为了防止重启即失效,可直接把命令放在<code>rc.local</code>中<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># route add <span class="section">default</span> gw <span class="number">192.168</span><span class="number">.7</span><span class="number">.39</span>  在OpenVpnClient上添加如下指向</span><br><span class="line"># route -n</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/openvpn in net .png" alt=""><br><img src="/img/openvpn in net res .png" alt=""></p>
<p>第二种,走网段路由,在所有要通信的内网的机器上添加如下路由,把来自vpn内网段的数据都直接丢到OpenVpn服务器指定的内网ip上,一样也可以达到目的,但两种方式有个共同的确定,机器比较少的情况下也许还能凑活,如果有几千台机器,每台上都要添加一条这样的指向毕竟是很不现实的<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># route add -net <span class="number">10.18</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> gw <span class="number">192.168</span><span class="number">.7</span><span class="number">.39</span>  在OpenVpnClient上添加如下指向</span><br><span class="line"># route -n</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/secode network.png" alt=""><br><img src="/img/secode network res.png" alt=""></p>
<p>所以,我们再来看第三种,利用iptables进行NAT转换,即把源地址为<code>10.18.0.0/24</code>都转换到指定的内网卡ip上,这样就不用再逐个指定网关了<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># /etc/init.d/iptables status  只需在OpenVpnServer服务器上添加如下规则即可</span><br><span class="line"># /sbin/iptables -t nat -A POSTROUTING -s <span class="number">10.18</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> -o eth2 -j SNAT --to-source <span class="number">192.168</span><span class="number">.7</span><span class="number">.39</span>	添加规则</span><br><span class="line"># /sbin/iptables -t nat -D POSTROUTING -s <span class="number">10.18</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> -o eth2 -j SNAT --to-source <span class="number">192.168</span><span class="number">.7</span><span class="number">.39</span>	删除规则</span><br><span class="line"># /etc/init.d/iptables stop</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/iptables three.png" alt=""><br><img src="/img/iptables three res.png" alt=""></p>
<p>0x12 实际生产环境中,由于各种各样的原因,有时可能还需要禁止指定的客户端用户登陆,方法非常简单,直接注销指定的客户端证书,万一要连续禁用多个vpn账号,那就直接一次性注销多个客户端证书,执行revoke-full后直接覆盖原来的crl.pem文件即可,如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /root/openvpn-2.2.2/easy-rsa/2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> vars</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi /root/openvpn-2.2.2/easy-rsa/2.0/openssl-1.0.0.cnf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tail -n 6 /root/openvpn-2.2.2/easy-rsa/2.0/openssl-1.0.0.cnf	先注释如下行</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">[ pkcs11_section ]</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">engine_id = pkcs11</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">dynamic_path = /usr/lib/engines/engine_pkcs11.so</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">MODULE_PATH = <span class="variable">$ENV</span>::PKCS11_MODULE_PATH</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">PIN = <span class="variable">$ENV</span>::PKCS11_PIN</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">init = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ./revoke-full client	指定要注销的客户端用户执行注销</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat keys/crl.pem</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat keys/index.txt	从该文件中可看到客户端用户的状态,R为已注销</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp keys/crl.pem /etc/openvpn/keys/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/openvpn/server.conf	再到主配置文件中添加该pem文件位置,然后重启openvpn,该用户登陆即会失效</span></span><br><span class="line">  crl-verify /etc/openvpn/keys/crl.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/init.d/openvpn restart</span></span><br></pre></td></tr></table></figure></p>
<p>下面是vpn账户被禁用后再登陆的效果,你会发现客户端的连接在一直被reset掉</p>
<p><img src="/img/client error.png" alt=""></p>
<p><br></p>
<p>后话:<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vpn作为直插目标内部的一个最直接的入口,也颇受入侵者的热爱,尤其是对各种APT团队来讲更是如此,针对此所进行的各种形式的钓鱼也从未休止</span><br><span class="line">其实,关于openvpn自身的漏洞并不多,甚至可以说,几乎没有,有也只是一些第三方库的,另外,基本也不存在什么错误配置能辅助我们渗透的</span><br><span class="line">关于openvpn的内部通信过程,大家可自行拿wireshark<span class="meta">&amp;tcpdump仔细好好跟一下基本就看明白了,如果真想深入研究建议直接去阅读2.2的源码</span></span><br><span class="line">在部署上基本无任何技术含量,只是为了方便大家用,顺便给自己做个备忘,保证后续随时能用即可</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    


    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    klion
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://evil-404.github.io/hidsdesd-vpn.html" title="OpenVpn 安全部署实战指南 [一]">https://evil-404.github.io/hidsdesd-vpn.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>



      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/openvpn/" rel="tag"><i class="fa fa-tag"></i>openvpn</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/pptp-config.html" rel="next" title="web渗透第一步之信息搜集 [win 2008 配置pptp]">
                <i class="fa fa-chevron-left"></i> web渗透第一步之信息搜集 [win 2008 配置pptp]
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/search-ipinfo.html" rel="prev" title="web渗透第一步 之 信息搜集 [ 搜集目标真实ip信息 ]">
                web渗透第一步 之 信息搜集 [ 搜集目标真实ip信息 ] <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://ws1.sinaimg.cn/large/baeae4e0ly1fsu7yzju7lj20af0a0wej.jpg"
                alt="VK" />
            
              <p class="site-author-name" itemprop="name">VK</p>
              <p class="site-description motion-element" itemprop="description">别惹我,我疯起来连自己都黑！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">162</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">115</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">110</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Hack-with-Github/Awesome-Hacking" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:evil-404@protonmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/HackwithGithub" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                安全资讯
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.freebuf.com" title="FreeBuf" target="_blank">FreeBuf</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.secfree.com" title="指尖安全" target="_blank">指尖安全</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.sec-wiki.com" title="SecWiki" target="_blank">SecWiki</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xz.aliyun.com" title="先知社区" target="_blank">先知社区</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.4hou.com" title="嘶吼" target="_blank">嘶吼</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.anquanke.com" title="安全客" target="_blank">安全客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.aqniu.com" title="安全牛" target="_blank">安全牛</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.easyaq.com" title="E安全" target="_blank">E安全</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>
       
      

      

<div id="days"></div>
</script>
<script language="javascript">
function show_date_time(){
window.setTimeout("show_date_time()", 1000);
BirthDay=new Date("07/01/2018 15:00:00");
today=new Date();
timeold=(today.getTime()-BirthDay.getTime());
sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);
msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);
e_hrsold=(e_daysold-daysold)*24;
hrsold=setzero(Math.floor(e_hrsold));
e_minsold=(e_hrsold-hrsold)*60;
minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
seconds=setzero(Math.floor((e_minsold-minsold)*60));
document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
if (i<10)
{i="0" + i};
return i;
}
show_date_time();
</script>

  
    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">VK</span>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共309.9k字</span>
</div>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://evil-404.github.io/">Evil-404</a> 维护</div>



  <span class="post-meta-divider">|</span>






<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>



  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v="></script>

  <script type="text/javascript" src="/js/src/motion.js?v="></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v="></script>
<script type="text/javascript" src="/js/src/post-details.js?v="></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v="></script>



  


  




	





  





  












  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v="></script>



  

  

  

  
  

  

  

  

</body>
</html>
